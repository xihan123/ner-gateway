<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NER 数据飞轮平台</title>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
  <link rel="preload" href="https://unpkg.com/vue@3/dist/vue.global.prod.js" as="script">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            accent: {
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
            }
          }
        }
      }
    }
  </script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .highlight-name {
      background: linear-gradient(120deg, #c084fc 0%, #818cf8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 600;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .dark .glass-card {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-gradient {
      background: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
      transition: all 0.2s ease;
    }

    .btn-gradient:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.4);
    }

    .btn-gradient:active {
      transform: translateY(0);
    }

    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .dark .shimmer {
      background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
      background-size: 200% 100%;
    }

    .confidence-bar {
      transition: width 0.5s ease;
    }

    .name-tag {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .toast-enter-active,
    .toast-leave-active {
      transition: all 0.3s ease;
    }

    .toast-enter-from {
      opacity: 0;
      transform: translateX(100%);
    }

    .toast-leave-to {
      opacity: 0;
      transform: translateX(100%);
    }

    .stats-card {
      min-height: 60px;
      contain: layout style;
    }

    .stats-card p:first-of-type {
      min-height: 28px;
    }

    .main-content {
      min-height: calc(100vh - 280px);
      contain: layout;
    }

    .filter-panel {
      min-height: 52px;
      contain: layout style;
    }

    .review-card {
      min-height: 160px;
      contain: layout style;
    }

    .skeleton-card {
      min-height: 160px;
      height: 160px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.7);
    }

    .load-more-trigger {
      min-height: 60px;
    }

    .load-more-spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-violet-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen transition-colors duration-300">
<div id="app-skeleton" class="min-h-screen flex flex-col">
  <header class="sticky top-0 z-50 bg-white/70 backdrop-blur-xl border-b border-white/20 shrink-0">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-sky-500 to-violet-500"></div>
        <div>
          <div class="h-6 w-28 bg-slate-200 dark:bg-slate-700 rounded animate-pulse"></div>
          <div class="h-3 w-36 bg-slate-100 dark:bg-slate-800 rounded mt-1 animate-pulse"></div>
        </div>
      </div>
      <div class="flex gap-2">
        <div class="h-9 w-16 bg-emerald-400 rounded-xl animate-pulse"></div>
        <div class="h-9 w-9 bg-slate-200 dark:bg-slate-700 rounded-lg animate-pulse"></div>
      </div>
    </div>
  </header>
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white/70 backdrop-blur-xl rounded-2xl p-4 mb-6 min-h-[52px]"></div>
    <div class="grid grid-cols-5 gap-3 mb-6">
      <div class="bg-white/70 backdrop-blur-xl rounded-xl p-3 min-h-[60px] animate-pulse" style="animation-delay: 0.1s"></div>
      <div class="bg-white/70 backdrop-blur-xl rounded-xl p-3 min-h-[60px] animate-pulse" style="animation-delay: 0.15s"></div>
      <div class="bg-white/70 backdrop-blur-xl rounded-xl p-3 min-h-[60px] animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="bg-white/70 backdrop-blur-xl rounded-xl p-3 min-h-[60px] animate-pulse" style="animation-delay: 0.25s"></div>
      <div class="bg-white/70 backdrop-blur-xl rounded-xl p-3 min-h-[60px] animate-pulse" style="animation-delay: 0.3s"></div>
    </div>
    <div class="space-y-4">
      <div class="bg-white/70 backdrop-blur-xl rounded-2xl p-5 min-h-[160px] animate-pulse"></div>
      <div class="bg-white/70 backdrop-blur-xl rounded-2xl p-5 min-h-[160px] animate-pulse" style="animation-delay: 0.1s"></div>
      <div class="bg-white/70 backdrop-blur-xl rounded-2xl p-5 min-h-[160px] animate-pulse" style="animation-delay: 0.2s"></div>
    </div>
  </main>
  <footer class="text-center py-4 text-sm text-slate-400 shrink-0">
    <p>NER 数据飞轮 · 全量数据收集 → 人工纠错 → 定期重训</p>
  </footer>
</div>
<div id="app"></div>
<script>
  const { createApp, ref, reactive, computed, onMounted, onUnmounted, nextTick, watchEffect, shallowRef } = Vue

  const highlightCache = new Map()
  const MAX_CACHE_SIZE = 500

  const cacheHighlight = (key, result) => {
    if (highlightCache.size >= MAX_CACHE_SIZE) {
      const firstKey = highlightCache.keys().next().value
      highlightCache.delete(firstKey)
    }
    highlightCache.set(key, result)
    return result
  }

  createApp({
    setup() {
      const reviews = shallowRef([])
      const stats = ref({ total: 0, pending: 0, approved: 0, corrected: 0, rejected: 0 })
      const loading = ref(true)
      const error = ref(null)
      const darkMode = ref(false)
      const correctionInputs = reactive({})
      const submitting = reactive({})
      const exportLoading = ref(false)

      const pageSize = 20
      const currentOffset = ref(0)
      const totalCount = ref(0)
      const hasMore = ref(true)
      const loadingMore = ref(false)
      let lastLoadTime = 0

      const showFilters = ref(false)
      const filters = reactive({
        status: 'pending',
        confidenceMin: null,
        confidenceMax: null,
        hasNames: null
      })
      const activeFiltersCount = computed(() => {
        let count = 0
        if (filters.status) count++
        if (filters.confidenceMin !== null && filters.confidenceMin !== '') count++
        if (filters.confidenceMax !== null && filters.confidenceMax !== '') count++
        if (filters.hasNames !== null && filters.hasNames !== '') count++
        return count
      })

      const toasts = ref([])
      let toastId = 0

      const showToast = (message, type = 'info') => {
        const id = ++toastId
        toasts.value.push({ id, message, type })
        setTimeout(() => {
          toasts.value = toasts.value.filter(t => t.id !== id)
        }, 3000)
      }

      const getToastColor = (type) => {
        switch (type) {
          case 'success': return 'bg-emerald-500'
          case 'error': return 'bg-rose-500'
          case 'warning': return 'bg-amber-500'
          default: return 'bg-blue-500'
        }
      }

      const getToastIcon = (type) => {
        switch (type) {
          case 'success': return 'M5 13l4 4L19 7'
          case 'error': return 'M6 18L18 6M6 6l12 12'
          case 'warning': return 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'
          default: return 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
        }
      }

      const getConfidenceColor = (confidence) => {
        if (confidence >= 0.9) return 'text-emerald-500'
        if (confidence >= 0.7) return 'text-amber-500'
        return 'text-rose-500'
      }

      const getConfidenceBg = (confidence) => {
        if (confidence >= 0.9) return 'bg-emerald-500'
        if (confidence >= 0.7) return 'bg-amber-500'
        return 'bg-rose-500'
      }

      const escapeHtml = (text) => {
        if (!text) return ''
        return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
      }

      const highlightText = (text, names) => {
        if (!text) return ''

        const cacheKey = `${text}||${(names || []).join(',')}`
        if (highlightCache.has(cacheKey)) {
          return highlightCache.get(cacheKey)
        }

        let escaped = escapeHtml(text)

        if (names && names.length > 0) {
          const sortedNames = [...names].filter(n => n).sort((a, b) => b.length - a.length)
          sortedNames.forEach(name => {
            if (name) {
              const escapedNameStr = escapeHtml(name)
              const escapedName = escapedNameStr.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
              const regex = new RegExp(`(${escapedName})`, 'gi')
              escaped = escaped.replace(regex, '<span class="highlight-name">$1</span>')
            }
          })
        }

        return cacheHighlight(cacheKey, escaped)
      }

      const initCorrectionInput = (item) => {
        if (!correctionInputs[item.id]) {
          correctionInputs[item.id] = item.predicted_names ? [...item.predicted_names] : ['']
        }
      }

      const addNameInput = (item) => {
        initCorrectionInput(item)
        correctionInputs[item.id].push('')
      }

      const removeNameInput = (item, index) => {
        initCorrectionInput(item)
        if (correctionInputs[item.id].length > 1) {
          correctionInputs[item.id].splice(index, 1)
        }
      }

      const fetchStats = async () => {
        try {
          const res = await fetch('/api/stats')
          if (res.ok) {
            stats.value = await res.json()
          }
        } catch (e) {
          console.error('获取统计失败:', e)
        }
      }

      const buildFilterUrl = (offset = 0) => {
        const params = new URLSearchParams()
        if (filters.status) params.append('status', filters.status)
        if (filters.confidenceMin !== null && filters.confidenceMin !== '') params.append('confidence_min', filters.confidenceMin)
        if (filters.confidenceMax !== null && filters.confidenceMax !== '') params.append('confidence_max', filters.confidenceMax)
        if (filters.hasNames !== null && filters.hasNames !== '') params.append('has_names', filters.hasNames)
        params.append('limit', String(pageSize))
        params.append('offset', String(offset))

        const queryString = params.toString()
        return `/api/reviews/filter?${queryString}`
      }

      const fetchReviews = async () => {
        reviews.value = []
        currentOffset.value = 0
        loading.value = true
        error.value = null
        hasMore.value = true

        try {
          const url = buildFilterUrl(0)
          const res = await fetch(url)
          if (!res.ok) {
            throw new Error(`获取数据失败: ${res.status} ${res.statusText}`)
          }
          const data = await res.json()
          reviews.value = (data.items || []).map(item => ({
            ...item,
            predicted_names: item.predicted_names || []
          }))
          totalCount.value = data.total || 0
          currentOffset.value = pageSize
          hasMore.value = data.has_more === true
        } catch (e) {
          error.value = e.message
          reviews.value = []
          showToast('获取数据失败: ' + e.message, 'error')
        } finally {
          loading.value = false
        }
        fetchStats().catch(console.error)
      }

      const loadMore = async () => {
        const now = Date.now()
        if (now - lastLoadTime < 300) return
        if (loadingMore.value || !hasMore.value) return

        lastLoadTime = now
        loadingMore.value = true
        try {
          const url = buildFilterUrl(currentOffset.value)
          const res = await fetch(url)
          if (!res.ok) {
            throw new Error(`加载失败: ${res.status}`)
          }
          const data = await res.json()
          const newItems = (data.items || []).map(item => ({
            ...item,
            predicted_names: item.predicted_names || []
          }))

          reviews.value = [...reviews.value, ...newItems]
          currentOffset.value += pageSize
          hasMore.value = data.has_more === true
        } catch (e) {
          console.error('加载更多失败:', e)
          showToast('加载更多失败', 'error')
        } finally {
          loadingMore.value = false
        }
      }

      const resetFilters = () => {
        filters.status = 'pending'
        filters.confidenceMin = null
        filters.confidenceMax = null
        filters.hasNames = null
        fetchReviews()
      }

      const applyFilters = () => {
        fetchReviews()
      }

      const processReviewAction = async (item, action, payload = {}) => {
        if (submitting[item.id]) return false

        submitting[item.id] = true
        try {
          const res = await fetch(`/api/reviews/${item.id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, ...payload })
          })

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}))
            throw new Error(errorData.error || `请求失败: ${res.status}`)
          }

          await nextTick()

          const idx = reviews.value.findIndex(r => r.id === item.id)
          if (idx !== -1) {
            const newList = [...reviews.value]
            newList.splice(idx, 1)
            reviews.value = newList
            totalCount.value = Math.max(0, totalCount.value - 1)
          }
          delete correctionInputs[item.id]

          fetchStats().catch(console.error)
          return true
        } catch (e) {
          console.error(`${action}失败:`, e)
          showToast(`${action}失败: ${e.message}`, 'error')
          return false
        } finally {
          submitting[item.id] = false
        }
      }

      const confirmCorrect = async (item) => {
        showToast('已确认', 'success')
        await processReviewAction(item, 'approve')
      }

      const clearCorrection = (item) => {
        correctionInputs[item.id] = ['']
      }

      const correctNames = async (item) => {
        const names = (correctionInputs[item.id] || []).filter(n => n && n.trim())
        showToast(names.length === 0 ? '已标记为无姓名' : '已修正', 'success')
        await processReviewAction(item, 'correct', { names })
      }

      const rejectItem = async (item) => {
        showToast('已拒绝', 'success')
        await processReviewAction(item, 'reject')
      }

      const exportData = async (format = 'bio') => {
        if (exportLoading.value) return

        exportLoading.value = true
        try {
          const res = await fetch(`/api/export?format=${format}`)
          if (!res.ok) throw new Error(`导出失败: ${res.status}`)

          const blob = await res.blob()
          const url = window.URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = 'training_data.jsonl'
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)
          window.URL.revokeObjectURL(url)
          showToast('导出成功', 'success')
        } catch (e) {
          console.error('导出失败:', e)
          showToast('导出失败: ' + e.message, 'error')
        } finally {
          exportLoading.value = false
        }
      }

      const toggleDarkMode = () => {
        darkMode.value = !darkMode.value
        document.documentElement.classList.toggle('dark', darkMode.value)
      }

      let scrollObserver = null
      const setupScrollObserver = () => {
        if (scrollObserver) scrollObserver.disconnect()

        scrollObserver = new IntersectionObserver((entries) => {
          if (entries[0].isIntersecting && hasMore.value && !loadingMore.value) {
            loadMore()
          }
        }, { rootMargin: '200px' })
      }

      onMounted(() => {
        const skeleton = document.getElementById('app-skeleton')
        if (skeleton) {
          skeleton.remove()
        }

        setupScrollObserver()
        fetchReviews()
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          darkMode.value = true
          document.documentElement.classList.add('dark')
        }
      })

      onUnmounted(() => {
        if (scrollObserver) scrollObserver.disconnect()
      })

      const loadMoreRef = ref(null)

      watchEffect((onCleanup) => {
        const el = loadMoreRef.value
        if (el && scrollObserver) {
          scrollObserver.observe(el)
          onCleanup(() => {
            scrollObserver.unobserve(el)
          })
        }
      }, { flush: 'post' })

      return {
        reviews,
        stats,
        loading,
        loadingMore,
        error,
        darkMode,
        correctionInputs,
        submitting,
        exportLoading,
        pageSize,
        currentOffset,
        totalCount,
        hasMore,
        loadMoreRef,
        showFilters,
        filters,
        activeFiltersCount,
        resetFilters,
        applyFilters,
        toasts,
        showToast,
        getToastColor,
        getToastIcon,
        getConfidenceColor,
        getConfidenceBg,
        highlightText,
        initCorrectionInput,
        addNameInput,
        removeNameInput,
        fetchStats,
        fetchReviews,
        loadMore,
        confirmCorrect,
        correctNames,
        clearCorrection,
        rejectItem,
        exportData,
        toggleDarkMode,
      }
    },
    template: `
      <div class="min-h-screen flex flex-col">
              <div class="fixed top-4 right-4 z-[100] space-y-2">          <TransitionGroup name="toast">
            <div v-for="toast in toasts" :key="toast.id"
                 class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white min-w-[280px] max-w-md"
                 :class="getToastColor(toast.type)">
              <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="getToastIcon(toast.type)"/>
              </svg>
              <span class="text-sm font-medium">{{ toast.message }}</span>
            </div>
          </TransitionGroup>
        </div>

        <header class="sticky top-0 z-50 glass-card border-b border-white/20 shrink-0">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl btn-gradient flex items-center justify-center shadow-lg">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                </div>
                <div>
                  <h1 class="text-xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-white dark:to-slate-300 bg-clip-text text-transparent">
                    NER 数据飞轮
                  </h1>
                  <p class="text-xs text-slate-500 dark:text-slate-400">姓名识别数据收集与纠正</p>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <div v-if="totalCount > 0" class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm">
                  <span class="text-slate-500 dark:text-slate-400">显示</span>
                  <span class="font-semibold text-slate-700 dark:text-slate-200">{{ reviews.length }}</span>
                  <span class="text-slate-500 dark:text-slate-400">/ {{ totalCount }}</span>
                </div>

                <button @click="exportData('bio')"
                        :disabled="exportLoading"
                        class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-medium transition-all shadow-lg shadow-emerald-500/25 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg v-if="exportLoading" class="w-4 h-4 load-more-spinner" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <svg v-else class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                  </svg>
                  <span class="hidden sm:inline">导出</span>
                </button>

                <button @click="fetchReviews"
                        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                        :class="{ 'load-more-spinner': loading }">
                  <svg class="w-5 h-5 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                </button>

                <button @click="toggleDarkMode"
                        class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                  <svg v-if="!darkMode" class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                  </svg>
                  <svg v-else class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </header>

        <main class="main-content flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
          <div class="filter-panel glass-card rounded-2xl p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex flex-wrap gap-2">
                <button @click="filters.status = 'pending'; applyFilters()"
                        class="px-3 py-1.5 text-sm rounded-lg transition-all"
                        :class="filters.status === 'pending' ? 'bg-amber-500 text-white' : 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 hover:bg-amber-200 dark:hover:bg-amber-900/50'">
                  待审核 ({{ stats.pending }})
                </button>
                <button @click="filters.status = 'approved'; applyFilters()"
                        class="px-3 py-1.5 text-sm rounded-lg transition-all"
                        :class="filters.status === 'approved' ? 'bg-emerald-500 text-white' : 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-200 dark:hover:bg-emerald-900/50'">
                  已确认 ({{ stats.approved }})
                </button>
                <button @click="filters.status = 'corrected'; applyFilters()"
                        class="px-3 py-1.5 text-sm rounded-lg transition-all"
                        :class="filters.status === 'corrected' ? 'bg-violet-500 text-white' : 'bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 hover:bg-violet-200 dark:hover:bg-violet-900/50'">
                  已修正 ({{ stats.corrected }})
                </button>
                <button @click="filters.status = 'rejected'; applyFilters()"
                        class="px-3 py-1.5 text-sm rounded-lg transition-all"
                        :class="filters.status === 'rejected' ? 'bg-rose-500 text-white' : 'bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 hover:bg-rose-200 dark:hover:bg-rose-900/50'">
                  已拒绝 ({{ stats.rejected }})
                </button>
                <button @click="filters.status = ''; applyFilters()"
                        class="px-3 py-1.5 text-sm rounded-lg transition-all"
                        :class="filters.status === '' ? 'bg-slate-500 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'">
                  全部
                </button>
              </div>

              <button @click="showFilters = !showFilters"
                      class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-all"
                      :class="showFilters ? 'bg-primary-500 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                更多筛选
                <span v-if="activeFiltersCount > 1" class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-white/20">
                    {{ activeFiltersCount - 1 }}
                  </span>
              </button>

              <button v-if="activeFiltersCount > 0" @click="resetFilters"
                      class="ml-auto flex items-center gap-1 px-3 py-1.5 text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                重置
              </button>
            </div>

                        <div v-if="showFilters" class="mt-4 pt-4 border-t border-slate-200/50 dark:border-slate-700/50">
                          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">                <div class="space-y-2">
                  <label class="text-sm font-medium text-slate-600 dark:text-slate-300">置信度范围</label>
                  <div class="flex items-center gap-2">
                    <input type="number" v-model.number="filters.confidenceMin"
                           placeholder="最小" min="0" max="1" step="0.1"
                           class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <span class="text-slate-400">-</span>
                    <input type="number" v-model.number="filters.confidenceMax"
                           placeholder="最大" min="0" max="1" step="0.1"
                           class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500">
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="text-sm font-medium text-slate-600 dark:text-slate-300">提取结果</label>
                  <div class="flex gap-2">
                    <button @click="filters.hasNames = true; applyFilters()"
                            class="flex-1 px-3 py-2 text-sm rounded-lg transition-all"
                            :class="filters.hasNames === true ? 'bg-primary-500 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'">
                      有姓名
                    </button>
                    <button @click="filters.hasNames = false; applyFilters()"
                            class="flex-1 px-3 py-2 text-sm rounded-lg transition-all"
                            :class="filters.hasNames === false ? 'bg-primary-500 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'">
                      无姓名
                    </button>
                    <button @click="filters.hasNames = null; applyFilters()"
                            class="flex-1 px-3 py-2 text-sm rounded-lg transition-all"
                            :class="filters.hasNames === null ? 'bg-slate-500 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'">
                      全部
                    </button>
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="text-sm font-medium text-slate-600 dark:text-slate-300">操作</label>
                  <button @click="applyFilters"
                          class="w-full px-4 py-2 btn-gradient text-white rounded-lg font-medium shadow-lg">
                    应用筛选
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-5 gap-3 mb-6">
            <div class="stats-card glass-card rounded-xl p-3">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                </div>
                <div>
                  <p class="text-xl font-bold text-slate-800 dark:text-white">{{ stats.total }}</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">总数据</p>
                </div>
              </div>
            </div>

            <div class="stats-card glass-card rounded-xl p-3">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <p class="text-xl font-bold text-amber-500">{{ stats.pending }}</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">待审核</p>
                </div>
              </div>
            </div>

            <div class="stats-card glass-card rounded-xl p-3">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <div>
                  <p class="text-xl font-bold text-emerald-500">{{ stats.approved }}</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">已确认</p>
                </div>
              </div>
            </div>

            <div class="stats-card glass-card rounded-xl p-3">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </div>
                <div>
                  <p class="text-xl font-bold text-violet-500">{{ stats.corrected }}</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">已修正</p>
                </div>
              </div>
            </div>

            <div class="stats-card glass-card rounded-xl p-3">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center">
                  <svg class="w-4 h-4 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </div>
                <div>
                  <p class="text-xl font-bold text-rose-500">{{ stats.rejected }}</p>
                  <p class="text-xs text-slate-500 dark:text-slate-400">已拒绝</p>
                </div>
              </div>
            </div>
          </div>

          <div v-if="error && !loading" class="glass-card rounded-2xl p-8 text-center mb-8">
            <div class="w-16 h-16 mx-auto rounded-full bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center mb-4">
              <svg class="w-8 h-8 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-2">加载失败</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-4">{{ error }}</p>
            <button @click="fetchReviews"
                    class="btn-gradient text-white px-6 py-2.5 rounded-xl font-medium shadow-lg">
              重试
            </button>
          </div>

          <div v-if="loading" class="space-y-4">
            <div v-for="i in 5" :key="i" class="skeleton-card glass-card rounded-2xl p-5">
              <div class="animate-pulse space-y-3">
                <div class="h-3 shimmer rounded w-1/2"></div>
                <div class="h-4 shimmer rounded w-3/4"></div>
                <div class="flex gap-3 mt-3">
                  <div class="h-9 shimmer rounded-lg w-24"></div>
                  <div class="h-9 shimmer rounded-lg flex-1"></div>
                </div>
              </div>
            </div>
          </div>

          <div v-else-if="reviews.length === 0 && !error" class="glass-card rounded-2xl p-12 text-center">
            <div class="w-20 h-20 mx-auto rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mb-4">
              <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-slate-800 dark:text-white mb-2">审核完成！</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-4">当前筛选条件下没有待处理数据</p>
            <div class="flex gap-3 justify-center">
              <button @click="fetchReviews"
                      class="btn-gradient text-white px-6 py-2.5 rounded-xl font-medium shadow-lg">
                刷新
              </button>
              <button @click="exportData('bio')"
                      class="px-6 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-medium shadow-lg">
                导出训练数据
              </button>
            </div>
          </div>

          <div v-else-if="!error" class="space-y-4">
            <div v-for="item in reviews" :key="item.id"
                 class="review-card glass-card rounded-2xl p-5 hover:shadow-xl transition-shadow duration-150">
              <div class="flex flex-col lg:flex-row lg:items-start gap-5">
                <div class="flex-1 space-y-3">
                  <div class="flex items-center gap-3">
                    <span class="text-xs font-medium text-slate-500 dark:text-slate-400">置信度</span>
                    <div class="flex-1 max-w-28 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                      <div class="h-full confidence-bar rounded-full"
                           :class="getConfidenceBg(item.confidence)"
                           :style="{ width: (item.confidence * 100) + '%' }">
                      </div>
                    </div>
                    <span class="text-xs font-bold" :class="getConfidenceColor(item.confidence)">
                        {{ (item.confidence * 100).toFixed(1) }}%
                      </span>
                  </div>

                  <div class="bg-white/50 dark:bg-slate-800/50 rounded-xl p-3 border border-slate-200/50 dark:border-slate-700/50">
                    <p class="text-slate-700 dark:text-slate-200 text-sm leading-relaxed"
                       v-html="highlightText(item.original_text, item.predicted_names)">
                    </p>
                  </div>

                  <div class="flex items-start gap-3">
                    <div class="flex items-center gap-1.5 shrink-0">
                      <svg class="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      <span class="text-xs text-slate-500 dark:text-slate-400">提取：</span>
                    </div>
                    <div class="flex flex-wrap gap-1.5">
                        <span v-for="(name, idx) in item.predicted_names" :key="idx"
                              class="name-tag px-2.5 py-0.5 bg-gradient-to-r from-violet-100 to-purple-100 dark:from-violet-900/30 dark:to-purple-900/30 rounded-lg text-violet-700 dark:text-violet-300 text-sm font-semibold">
                          {{ name }}
                        </span>
                      <span v-if="!item.predicted_names || item.predicted_names.length === 0"
                            class="px-2.5 py-0.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-400 text-sm">
                          未识别
                        </span>
                    </div>
                  </div>
                </div>

                <div class="lg:w-72 space-y-2.5 lg:border-l lg:border-slate-200/50 dark:lg:border-slate-700/50 lg:pl-5">
                  <p class="text-xs text-slate-400 font-medium">操作</p>

                  <div class="flex gap-2">
                    <button @click="confirmCorrect(item)"
                            :disabled="submitting[item.id]"
                            class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-medium transition-all shadow-lg shadow-emerald-500/25 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                      <svg v-if="submitting[item.id]" class="w-4 h-4 load-more-spinner" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <svg v-else class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      准确
                    </button>
                    <button @click="rejectItem(item)"
                            :disabled="submitting[item.id]"
                            class="px-3 py-2.5 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-600 dark:text-slate-300 rounded-xl font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>

                  <div class="space-y-2 p-2.5 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                    <p class="text-xs text-slate-500 font-medium">修正姓名</p>

                    <div class="space-y-1.5">
                      <div v-for="(name, idx) in (correctionInputs[item.id] || item.predicted_names || [''])" :key="idx"
                           class="flex gap-1.5">
                        <input type="text"
                               :value="correctionInputs[item.id] ? correctionInputs[item.id][idx] : (item.predicted_names && item.predicted_names[idx] ? item.predicted_names[idx] : '')"
                               @input="initCorrectionInput(item); correctionInputs[item.id][idx] = $event.target.value"
                               @keyup.enter="correctNames(item)"
                               :placeholder="'姓名 ' + (idx + 1)"
                               class="flex-1 px-2.5 py-1.5 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-violet-500 transition-all placeholder:text-slate-400"
                        />
                        <button v-if="(correctionInputs[item.id] || item.predicted_names || ['']).length > 1"
                                @click="removeNameInput(item, idx)"
                                class="px-2 py-1.5 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                          </svg>
                        </button>
                      </div>
                    </div>

                    <div class="flex gap-1.5 pt-1.5">
                      <button @click="addNameInput(item)"
                              class="flex items-center gap-1 px-2.5 py-1.5 text-xs text-violet-600 dark:text-violet-400 hover:bg-violet-50 dark:hover:bg-violet-900/20 rounded-lg transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        添加
                      </button>
                      <button @click="clearCorrection(item)"
                              class="flex items-center gap-1 px-2.5 py-1.5 text-xs text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-lg transition-colors">
                        清空
                      </button>
                      <button @click="correctNames(item)"
                              :disabled="submitting[item.id]"
                              class="flex-1 px-3 py-1.5 bg-rose-500 hover:bg-rose-600 text-white rounded-lg font-medium transition-all shadow-lg shadow-rose-500/25 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                        提交
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div ref="loadMoreRef" class="load-more-trigger flex items-center justify-center py-4">
              <div v-if="loadingMore" class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                <svg class="w-5 h-5 load-more-spinner" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm">加载更多...</span>
              </div>
              <div v-else-if="!hasMore && reviews.length > 0" class="text-slate-400 dark:text-slate-500 text-sm">
                已加载全部 {{ reviews.length }} 条数据
              </div>
            </div>
          </div>
        </main>

        <footer class="text-center py-4 text-sm text-slate-400 shrink-0">
          <p>NER 数据飞轮 · 全量数据收集 → 人工纠错 → 定期重训</p>
        </footer>
      </div>
    `
  }).mount('#app')
</script>
</body>
</html>